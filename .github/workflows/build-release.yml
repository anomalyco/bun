name: build-release
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Override version (leave empty to use LATEST-opencode)"
        required: false
        type: string

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: LATEST

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            BASE=$(cat LATEST | tr -d '[:space:]')
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            echo "version=${BASE}-opencode.${TIMESTAMP}" >> "$GITHUB_OUTPUT"
          fi

      - name: Print version
        run: echo "Building version ${{ steps.version.outputs.version }}"

  build-windows:
    needs: version
    runs-on: blacksmith-8vcpu-windows-2025
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Minimal bootstrap â€” Blacksmith Windows 2025 already has:
      #   VS Build Tools 2022, CMake, Go, Python, Ruby, Perl, Node, Git, Rust (stable)
      # We only need: LLVM 21 (has 20), nasm, ccache, ninja, mingw
      - name: Install LLVM 21
        run: |
          choco install llvm --yes --accept-license --no-progress --force --version=21.1.8
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install ATL headers
        run: |
          & "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vs_installer.exe" modify `
            --installPath "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools" `
            --add Microsoft.VisualStudio.Component.VC.ATL `
            --quiet --norestart --wait
        shell: pwsh

      - name: Install build tools
        run: choco install nasm ccache ninja mingw --yes --accept-license --no-progress --force

      - name: Verify toolchain
        run: |
          clang-cl --version
          cmake --version
          cargo --version
          ninja --version

      # Build modern variant
      - name: Build release (modern)
        run: bun run build:release
        env:
          CFLAGS: -w
          CXXFLAGS: -w
          RUSTFLAGS: -Awarnings

      - name: Package modern
        shell: bash
        run: |
          mkdir -p bun-windows-x64-pkg/package/bin
          cp build/release/bun.exe bun-windows-x64-pkg/package/bin/bun.exe
          tar -czf bun-windows-x64.tgz -C bun-windows-x64-pkg package

      # Build baseline variant (reuses same bootstrapped env)
      - name: Build release (baseline)
        run: bun run build:release --toolchain windows-x64-baseline
        env:
          CFLAGS: -w
          CXXFLAGS: -w
          RUSTFLAGS: -Awarnings

      - name: Package baseline
        shell: bash
        run: |
          mkdir -p bun-windows-x64-baseline-pkg/package/bin
          cp build/release/bun.exe bun-windows-x64-baseline-pkg/package/bin/bun.exe
          tar -czf bun-windows-x64-baseline.tgz -C bun-windows-x64-baseline-pkg package

      - uses: actions/upload-artifact@v4
        with:
          name: bun-windows
          path: |
            bun-windows-x64.tgz
            bun-windows-x64-baseline.tgz

  release:
    needs: [version, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4

      - name: Upload to GitHub Release
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          TAG="v${VERSION}"
          gh release create "$TAG" --prerelease --title "bun $VERSION" \
            --notes "Fork build $VERSION" --repo ${{ github.repository }} 2>/dev/null || true
          gh release upload "$TAG" \
            bun-windows/bun-windows-x64.tgz \
            bun-windows/bun-windows-x64-baseline.tgz \
            --clobber --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ github.token }}
